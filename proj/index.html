<!DOCTYPE html>
<meta charset="utf-8">

<body> 
  <script src="http://d3js.org/d3.v5.min.js" charset="utf-8"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <svg id="my_dataviz" width="400" height="300"></svg>
  <script>

    var width = 960,//700*2,//960,
	height = 500,// 580*2,//500,
	centered;
    
    var projection = d3.geoAlbers()
	.scale( 10000 )
	.rotate( [76.6413,0] )
	.center( [0, 39.0458] )
	.translate( [width/2,height/2] );
    var path = d3.geoPath()
	.projection(projection);
    var min, max;
    var covidData = d3.map();
    var svg = d3.select("body").append("svg")
	.attr("width", width)
	.attr("height", height);
    var group = svg.append('g')
    var files = ["http://localhost:5000/get_by_id/9", "https://raw.githubusercontent.com/deldersveld/topojson/master/countries/united-states/us-albers-counties.json"];
    var promises = [
	d3.json(files[1]),
	d3.json(files[0], function(d) {
        
	})
    ];
    var colorScale;
    /*var g = svg.append("g")
    .attr("class", "key")
    .attr("transform", "translate(0,40)");

    
g.append("text")
    .attr("class", "caption")
    .attr("x", x.range()[0])
    .attr("y", -6)
    .attr("fill", "#000")
    .attr("text-anchor", "start")
    .attr("font-weight", "bold")
    .text("Unemployment rate");
*/
    Promise.all(promises).then(ready);

    
    function ready(data,  error) {
	console.log(data);
	max= data[1]['counties']['allegany'];
	min = data[1]['counties']['allegany'];
	
	for(const[key, val] of Object.entries(data[1]['counties'])){

	    covidData.set(key.toLowerCase(), val);
	    if(val>max)
		max = val;
	    if(val<min)
		min = val;
	    
        }
	colorScale = d3.scaleThreshold()
            .domain(d3.range(min, max))
            .range(d3.schemeSpectral[11]);
	
	  svg.selectAll("path")
	    .attr("id", "state_fips")
	    .data(topojson.feature(data[0], data[0].objects.collection).features.filter(
		function(d) {
		    return d.properties.state_fips == 24; }))
	    .enter()
	    .append("path")
	    .attr("d", path)
	    .attr("stroke","white")
	    .attr("fill",
		  function(d) {
		      var name = d.properties.name.toLowerCase();
		      var areaType = d.properties.lsad.toLowerCase();

		      
		      //special cases for baltimore county and baltimore city, and st marys
		      if(name === "baltimore" && areaType === "county"){
			  d.covidCount = covidData.get("baltimore");
			  console.log(d)
		      }
		      else if(name === "baltimore" && areaType === "city"){
			  d.covidCount = covidData.get("baltimore city");
			  console.log("hi", d)
		      }
		      
		      if(name === "st. mary's"){
			  d.covidCount = covidData.get("st mary's");
		      }
		      
		      else{
			  d.covidCount = covidData.get(name);
		      }
		      //console.log(min, max)
		      console.log(name, areaType, d.covidCount);
		      return colorScale(d.covidCount);
		  })
	
	    .style("stroke", "transparent")
	    .style("opacity", .8);
	
    }
    
    
  </script>
