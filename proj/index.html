<!DOCTYPE html>
<meta charset="utf-8">

<style>
.tooltip {                                                   
    background: #f1f0f1;                                         
    box-shadow: 0 0 5px #999999;                              
    color: #333;                                           
    display: inline;                                                
    font-size: 14px; 
    font-family: Helvetica;		
    left: 300px;                                                   
    padding: 10px;                                                 
    position: absolute;                                            
    text-align: center;                                       
    top: 220px;                                                     
    width: 80px;                                                  
    z-index: 1000;                                                   
} 
  </style>
<body>
  <h1>COVID19 Cases by County</h1>
  <h2></h2>
  <script src="http://d3js.org/d3.v5.min.js" charset="utf-8"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
  <script src="https://unpkg.com/d3fc@14.0.27/build/d3fc.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
  <svg id="my_dataviz" width="400" height="300"></svg>
  <script>

    var width = 960,//700*2,//960,
	height = 500,// 580*2,//500,
	centered;
    var legendWidth = 40;
    var legendHeight = 100;
    var projection = d3.geoAlbers()
	.scale( 10000 )
	.rotate( [76.6413,0] )
	.center( [0, 39.0458] )
	.translate( [width/2,height/2] );
    var path = d3.geoPath()
	.projection(projection);
    var min, max;
    var covidData = d3.map();
    var svg = d3.select("body").append("svg")
	.attr("width", width)
	.attr("height", height);
    var group = svg.append('g')
    var files = ["http://localhost:5000/get_by_id/100", "https://raw.githubusercontent.com/deldersveld/topojson/master/countries/united-states/us-albers-counties.json"];
    var promises = [
	d3.json(files[1]),
	d3.json(files[0], function(d) {
        
	})
    ];
    var colorScale;

    Promise.all(promises).then(ready);

    
    function ready(data,  error) {
	console.log(data);
	max= data[1]['counties']['allegany'];
	min = data[1]['counties']['allegany'];
	var sum = 0;
	var count = 0;
	for(const[key, val] of Object.entries(data[1]['counties'])){
	    sum+=val;
	    count++;
	    covidData.set(key.toLowerCase(), val);
	    if(val>max)
			max = val;
	    if(val<min)
		min = val;
	    
        }
	
            
	var avg = Math.round(sum/count);
	
	
	console.log(min, Math.round((min+avg)/2), Math.round(avg), Math.round((max+avg)/2), max);

	colorScale = d3.scaleThreshold()
	    .domain([min, Math.round((min+avg)/2), avg, Math.round((max+avg)/2), max])
	    .range(d3.schemeBlues[6]);


	
	
	let mouseOver = function(d) {
            d3.selectAll(".county")
                .transition()
                  .duration(200)
                .style("opacity", .5)
            d3.select(this)
                .transition()
                .duration(200)
                .style("opacity", 1)
                .style("stroke", "black")

	    
	      
            
            tooltipLabel.text(d.properties.name + " " + d.properties.lsad + ": " + d.covidCount +  " cases"); 
            
            
            tooltip.style('display', 'block');
	    
	    	 
	    console.log(tooltip);
	    console.log(d.properties.name, d.properties.lsad, d.covidCount, "cases");
        };					
        
	
        let mouseLeave = function(d) {
            d3.selectAll(".county")
                .transition()
                .duration(200)
                .style("opacity", .8)
            d3.select(this)
                .transition()
                .duration(200)
                .style("stroke", "transparent")

	    tooltip.style('display', 'block');   
	    
	};
	
	var svgContainer = d3.select('#my_dataviz');
	var other_svg = svgContainer.append('svg')
	//tooltips
	var tooltip = svgContainer
            .append('div')
            .attr('class', 'tooltip');

    var tooltipLabel =   tooltip.append('div')
             .attr('class', 'label');

	var mousemove = function(d) {
	    //.html("The exact value of<br>this cell is: " + d.value)
	    
	  }
	svg.selectAll("path")
	    .attr("id", "state_fips")
	    .data(topojson.feature(data[0], data[0].objects.collection).features.filter(
		function(d) {
		    return d.properties.state_fips == 24; }))
	    .enter()
	    .append("path")
	    .attr("d", path)
	    .attr("stroke","white")
	    .attr("fill",
		  function(d) {
		      var name = d.properties.name.toLowerCase();
		      var areaType = d.properties.lsad.toLowerCase();
		      
		      //special cases for baltimore county and baltimore city, and st marys
		      if(name === "baltimore" && areaType === "county"){
			  d.covidCount = covidData.get("baltimore");
		      }
		      else if(name === "baltimore" && areaType === "city"){
			  d.covidCount = covidData.get("baltimore city");
		      }
		      
		      if(name === "st. mary's"){
			  d.covidCount = covidData.get("st mary's");
		      }
		      
		      else{
			  d.covidCount = covidData.get(name);
		      }
	//	      console.log(d);
		      return colorScale(d.covidCount);
		  })
	    .on("mouseover", mouseOver )
	    .on("mouseleave", mouseLeave )
	    .on("mousemove", mousemove)
	    .attr("class", "county")
	    .style("stroke", "transparent")
	    .style("opacity", .9);
	
	
	

	
	svg.append("g")
	    .attr("class", "legendQuant")
	    .attr("transform", "translate(20,20)");
	
	var legend = d3.legendColor()
	    .labelFormat(d3.format(".0f"))
	    .labels(d3.legendHelpers.thresholdLabels)
	    .scale(colorScale);

	svg.select(".legendQuant")
	    .call(legend);

  
		
    }
    
    
  </script>
